String cron_string = BRANCH_NAME == 'master' ? 'H H * * *' : ''

pipeline {
    agent {
        label 'vmbuild'
    }

    triggers {
        cron cron_string
    }

    options {
        buildDiscarder(logRotator(numToKeepStr: '5', artifactNumToKeepStr: '5'))
        disableConcurrentBuilds()
        timeout(time: 1, unit: 'HOURS')
        timestamps()
    }

    stages {
        stage('Setup') {
            steps {
                checkout scm

                sh 'cp docker.env.dist docker.env'
                withCredentials([
                    usernamePassword(
                        credentialsId: '<%= config.name %>_github_token',
                        usernameVariable: '',
                        passwordVariable: 'GITHUB_TOKEN'
                    ),
                    usernamePassword(
                        credentialsId: '<%= config.name %>_aws',
                        usernameVariable: 'AWS_ACCESS_KEY_ID',
                        passwordVariable: 'AWS_SECRET_ACCESS_KEY'
                    )
                ]) {
                    sh 'sed -i"" "s/GITHUB_TOKEN=/GITHUB_TOKEN=${GITHUB_TOKEN}/" docker.env'
                    sh 'sed -i"" "s/AWS_ACCESS_KEY_ID=/AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}/" docker.env'
                    sh 'sed -i"" "s/AWS_SECRET_ACCESS_KEY=/AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}/" docker.env'
                    sh 'sed -i"" "s/TIDEWAYS_API_KEY=/TIDEWAYS_API_KEY=tideways/" docker.env'
                }
                sh '''python -c "$(cat <<EOF
import sys, yaml
data = yaml.load(sys.stdin)
for service in data['services']:
  data['services'][service].pop('ports', None)
print yaml.dump(data, default_flow_style = False)
EOF
)" < docker-compose.override.yml.dist > docker-compose.override.yml.dist'''
                sh 'hem deps gems'
                sh 'hem exec bash -c \'rake docker:setup\''
            }
        }
        stage('Provision dev environments') {
            parallel {
                stage('Vagrant') {
                    steps {
                        sh 'eval "$(ssh-agent)" && ssh-add && hem vm rebuild'
                        sh 'hem exec bash -c \'cd tools/vagrant && rake\''
                    }
                    post {
                        always {
                            sh 'hem vm destroy'
                        }
                    }
                }
                stage('Docker Compose (stable tags)') {
                    steps {
                        sh 'hem exec bash -c \'rake docker:up\''
                    }
                    post {
                        always {
                            sh 'hem exec bash -c \'rake docker:down\''
                        }
                    }
                }
                stage('Docker Compose (latest tags)') {
                    steps {
                        script {
                            env.PATH_LATEST = sh(returnStdout: true, script: 'mktemp -d -p "${WORKSPACE}" ../<%= config.name %>-test-XXXXX').trim()
                        }

                        sh 'rm -rf "$PATH_LATEST" && cp -r "${WORKSPACE}" "$PATH_LATEST"'

                        dir(env.PATH_LATEST) {
                            sh 'sed -i -e \'s/^\\(quay.io\\/continuouspipe\\/.*:\\)stable\\s*$/\\1latest/\' docker-compose.yml Dockerfile'
                            sh 'hem exec bash -c \'rake docker:up\''
                        }
                    }
                    post {
                        always {
                            dir(env.PATH_LATEST) {
                                sh 'hem exec bash -c \'rake docker:down\''
                                deleteDir()
                            }
                        }
                    }
                }
            }
        }
    }
    post {
        failure {
            slackSend channel: '#jenkins-builds, #<%= config.name %>', color: 'danger', message: "${env.JOB_NAME} - #${env.BUILD_NUMBER} Failure after ${currentBuild.durationString} (<${env.RUN_DISPLAY_URL}|Open>)", tokenCredentialId: 'inviqa-slack-integration-token'
        }
    }
}
